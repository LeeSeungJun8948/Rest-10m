<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rest.app.bus.service.impl.BusinessMapper">
	<select id="getBus" resultType="com.rest.app.bus.vo.OrdersVO">
		select
		F_FINDCOMPNAME(company_code)AS comp_name,
		TO_CHAR(o.in_date,'YYYY-MM-DD')as in_date,
		TO_CHAR(o.out_date,'YYYY-MM-DD')as out_date,
		o.order_no,
		p.product_code,p.product_name,
		p.std_id,p.unit_id,o.order_count,o.out_count,
		(o.order_count -
		o.out_count) as not_count,
		CASE
		WHEN o.plan_count = 0
		THEN '미계획'
		WHEN
		o.order_count > o.plan_count THEN
		'진행중'
		ELSE '완료'
		END AS
		order_state
		FROM
		orders o, product p
		WHERE in_date BETWEEN
		TO_DATE(#{fromDate},'YYYY-MM-DD')
		AND TO_DATE(#{toDate}, 'YYYY-MM-DD')
		AND o.product_code=p.product_code
		<if test="companyCode !=null and companyCode !=''">
			and o.company_code=#{companyCode}
		</if>
		<if test="productCode !=null and productCode !=''">
			and o.product_code=#{productCode}
		</if>
		<if test="orderState == 'unPlan'">
			and o.plan_count = 0
		</if>
		<if test="orderState == 'working'">
			and o.order_count > o.plan_count AND o.plan_count > 0
		</if>
		<if test="orderState == 'planComplete'">
			and o.order_count = o.plan_count
		</if>
	</select>

	<select id="getUnExport"
		resultType="com.rest.app.bus.vo.OrdersVO"
		parameterType="com.rest.app.bus.vo.OrdersVO">
		select distinct
		p.product_code,p.product_name,p.std_id,p.unit_id,o.order_no,o.order_count,
		o.out_count,(o.order_count - o.out_count) as un_export,
		(SELECT
		SUM(product_count) FROM storage WHERE product_code = o.product_code
		AND product_state='포장완료') as dayCount
		from orders o, storage s, product
		p,export e
		where o.order_count != o.out_count
		and o.product_code =
		p.product_code
		and o.product_code =
		s.product_code
		and e.export_date
		BETWEEN TO_DATE(#{fromDate}, 'YYYY-MM-DD')
		AND
		TO_DATE(#{toDate},
		'YYYY-MM-DD')
	</select>

	<select id="searchExport"
		resultType="com.rest.app.bus.vo.ExportVO">
		SELECT export_code,
		to_char(export_date,'YYYY-MM-DD') export_date,
		company_code,
		comments from export
		WHERE export_date BETWEEN TO_DATE(#{fromDate}, 'YYYY-MM-DD')
		AND TO_DATE(#{toDate}, 'YYYY-MM-DD')
		ORDER BY export_code

	</select>

	<select id="searchPlan" resultType="PlanVO">
		SELECT plan_code, plan_name,
		TO_CHAR(plan_date, 'YYYY-MM-DD') plan_date, comments FROM plan
		WHERE plan_date BETWEEN TO_DATE(#{searchDtS}, 'YYYY-MM-DD')
		AND TO_DATE(#{searchDtE}, 'YYYY-MM-DD')
		ORDER BY plan_code
	</select>
	<select id="getDetailExport"
		resultType="com.rest.app.bus.vo.DetailExportVO">
		SELECT d.idx,d.export_code, d.order_no, d.product_code,
				d.price,d.comments,d.export_count,
				to_char(e.export_date,'YYYY-MM-DD')export_date,
				p.product_name,p.std_id,p.unit_id,
				(select out_count from orders where order_no = d.order_no)out_count,
				(select order_count - out_count from orders where order_no = d.order_no)
				unExport_count,
				to_char(e.export_date,'YYYY-MM-DD')export_date,
				(select company_code from orders where order_no = d.order_no)company_code
			from detailexport d, product p, export e
		WHERE e.export_code= #{exportCode}
			AND d.product_code = p.product_code
		ORDER BY d.idx;


	</select>
	<insert id="insertDetailExport"
		parameterType="com.rest.app.bus.vo.DetailExportVO">
		<selectKey keyProperty="idx" resultType="int" order="BEFORE">
			SELECT
			NVL(MAX(idx),0)+1 FROM detailExport
		</selectKey>
		INSERT INTO detailExport VALUES(
		#{idx}, #{exportCode}, #{orderNo},
		null, #{productCode}, #{exportCount}, #{price}, #{comments}
		)
	</insert>
	<update id="updateDetailExport"
		parameterType="com.rest.app.bus.vo.DetailExportVO">
		UPDATE detailExport SET export_count = #{exportCount},
		comments = #{comments}
		WHERE product_lot = #{productLot}
	</update>
	<delete id="deleteDetailExport">
		DELETE FROM detailExport WHERE idx = #{idx}
	</delete>
	<delete id="deleteAllDetailExport">
		DELETE FROM detailExport WHERE export_code =
		#{exportCode}
	</delete>


	<select id="getProInventory"
		resultType="com.rest.app.bus.vo.OrdersVO"
		parameterType="com.rest.app.bus.vo.OrdersVO">

		select p.product_code,p.product_name,p.std_id,p.unit_id,
		s.product_lot,s.product_count,s.product_state,d.export_code,
		e.export_date
		from DETAILEXPORT d
		inner join product p on
		p.product_code=d.product_code
		inner join storage s on
		s.product_code=d.product_code
		inner join export e on
		e.export_code=d.export_code
		WHERE e.export_date BETWEEN
		TO_DATE(#{fromDate},'YYYY-MM-DD')
		AND
		TO_DATE(#{toDate}, 'YYYY-MM-DD')
		<if test="productCode !=null and productCode !=''">
			and o.product_code=#{productCode}
		</if>
	</select>
</mapper>